

# 基于中央定位服务器的P2P网络聊天系统设计

自64 李姜帆 2016011819

## 题目要求

### 实验目的

* 考核学生对于计算机网络课程内容的掌握
* 锻炼将所学知识应用于实际中的能力

### 实验要求



![架构](C:\Users\Robot.Li\Desktop\计网\dzy1\架构.png)

|      | 功能            |
| ---- | ------------- |
| 必做内容 | 账号登陆上线/下线     |
|      | 通讯录（查询好友是否在线） |
|      | P2P通信         |
|      | 文件传输（10MB以上）  |
|      | 友好的用户界面       |
| 选做内容 | 群聊功能（一对多通信）   |
|      | 聊天记录查询        |
|      | 语音发送/动态表情     |
|      | 其他创新性的功能      |

## 程序简介

### 程序实验环境

|        |                    |
| ------ | ------------------ |
| 目标框架   | .net framework 4.  |
| 编辑器    | VS2015             |
| 计算机系统  | Windows10 家庭版 1803 |
| 操作系统版本 | 17134.472          |

### 程序功能简介



## 需求分析

### 窗体

在本次大作业中，需要实现一个类似QQ/微信的基于中央定位服务器的P2P网络聊天系统设计。鉴于目前大家使用微信的频率相对来说更高，本次大作业向微信的设计靠拢。

有两个主要的窗体：登陆界面和主界面。

登陆界面完成账户登陆；

主界面完成其他的主要任务，包括

* 好友/群聊列表；（由于一对一聊天和一对多聊天是分割的两项任务，故仍使用QQ早期群聊和单人对话分离的设计。）
* 好友搜索
* 聊天框
  * 文本发送
  * 对话显示
  * 群聊信息

### 程序架构

#### 各窗体架构

登陆窗体`Login`与服务器进行通信，完成登陆上线的功能。

主窗体`MainWin`是程序核心，首先以消息窗体打开登陆窗体`Login`，完成连接后，运行==客户机端==，接收消息并显示。同时，在用户操作下，完成：

* 好友在线查询(CS)
* 聊天/群聊发起(P2P)
* 属性修改
  * 昵称修改
  * 保存聊天记录

还有一个小的输入窗体`text`负责获取文本。（用在修改昵称处）

#### 通信架构

##### CS——与中央服务器的通信

该部分的协议由题目提供。

| 服务器地址： | 166.111.140.14    端口：8000                |                  |
| ------ | ---------------------------------------- | ---------------- |
| 通信类型   | 客户端发送指令                                  | 服务器返还指令          |
| 登录     | 用户名：本人学号，密码：net2018   例：“2016011000_net2018” | “lol”            |
| 查询好友状态 | “q+好友学号”   例：“q2016011001”               | IP地址(在)/“n”(不在线) |
| 下线     | ”logout+本人学号”   例：“logout2016011000”     | “loo”            |

##### P2P——与其他相同协议主机的通信

本部分的通信协议需要自己定义，以实现一对一通信/一对一文件传输和群聊通信。

为实现P2P通信，每台主机既作为服务器，又作为客户机，需要同时运行至少两个socket。协议需要指定

* 监听的欢迎套接字端口，并引导新的socket连接
* ​
* 定时检查连接情况

## 总体设计原理和架构

### 界面架构

#### 登陆界面

根据用户输入的学号，向中央服务器发起连接，

```c#
SocketClient = new Socket( AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.IP);
try SocketClient.Connect(ipep);
```

==为避免程序“假死”，应该新开一个线程。==

确认上线登陆

 ```c#
byte[] arrClientSendMsg = Encoding.UTF8.GetBytes(userID + psw);
SocketClient.Send(arrClientSendMsg); 
 ```

检查服务器返回的字符串，如果为`lol`即进入主界面。

#### 主窗体

##### CS通信

###### 下线功能

与登陆类似，向中央服务器发送`logout<学号>`即可。同时为避免误触，给用户一个取消退出的机会。

###### 好友查询

也与登陆类似，向中央服务器发送`q<学号>`可以获取状态。将查询过的账号加入到好友列表中，并修改状态。

##### 本机服务

###### 会话列表

通过通讯录记录好友`Friend`的信息：昵称/ID/IP/在线状态。

好友与群聊都是一种会话`Chat`，使用`ListView`显示可选的对话对象（单人是昵称与ID，群聊为名称与成员）。

会话有四种状态：离线/在线/新消息/对话中。（离线发送需要本机保存信息，目前没有写）

当前会话，即开启通信的会话

###### 昵称修改

通过`text`对话窗体获取修改的值，进行修改。

#### ==监听==

根据P2P通信协议定义套接字的回调函数，接收各种类型的信息并显示响应。

有消息的聊天标亮提醒。

#### 聊天

`Chat类：isGroup,Name,Socket,IDs,IPs`

显示当前对话的成员信息；

将输入的信息编码之后发送；

将接收的信息解码并显示在聊天框中；

文件的发送；

​    为避免程序卡死，应重新开启一个线程来传送文件，同时通过进度条显示传送进度。

### 通信架构

#### 数据包格式

* 连接
  * Single
    CON+userIDXXXXX+0
  * Group
    CON+userIDXXXXX+1+length(2)+membersIDX+GroupName

* 信息： s--i'm sever
  * Single 
    MSG+userIDXXXXX+0+length(4)+messages故发送时间以接收方为准
  * Group.
    MSG+userIDXXXXX+1+length(2)+membersIDX+length(4)+messages

数据类型：

* 连接信息 CON
  * 连接 1
    * 连接发起者ID 10位数字
    * 单独/群聊 0/1 
  * 断开 0


* 消息 MSG
  * 连接发起者ID 10位数字
  * 长度
  * 内容
* 文件 FLE
  - 连接发起者ID 10位数字
  - 长度
  - 内容

校验？

## 详细设计过程

## 最终实现的功能

### 必做

### 选作



## 程序运行实例

## 实验中遇到的问题及解决方案

## 总结收获

## 参考

## 附录：程序使用说明

n介绍提交的大作业中每个文件的作用

n提供可执行程序运行所需要的必要组件